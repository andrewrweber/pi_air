<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi System Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üçì Raspberry Pi System Monitor</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h2>CPU</h2>
                <div class="stat-value" id="cpu-usage">Loading...</div>
                <div class="stat-label">Usage</div>
                <div class="stat-value" id="cpu-temp">Loading...</div>
                <div class="stat-label">Temperature</div>
            </div>
            
            <div class="stat-card">
                <h2>Memory</h2>
                <div class="stat-value" id="memory-usage">Loading...</div>
                <div class="stat-label">Usage</div>
                <div class="stat-detail" id="memory-detail"></div>
            </div>
            
            <div class="stat-card">
                <h2>System Info</h2>
                <div id="system-info" class="info-list"></div>
            </div>
            
            <div class="stat-card">
                <h2>Network</h2>
                <div id="network-info" class="info-list"></div>
            </div>
        </div>
        
        <div class="disk-section">
            <h2>Disk Usage</h2>
            <div id="disk-info"></div>
        </div>
        
        <div class="temperature-section">
            <h2>CPU Temperature History (10 minutes)</h2>
            <canvas id="temperatureChart" width="400" height="200"></canvas>
        </div>
        
        <div class="footer">
            <p>Last updated: <span id="last-update">Never</span></p>
        </div>
    </div>
    
    <script>
        // Initialize temperature chart
        const ctx = document.getElementById('temperatureChart').getContext('2d');
        const temperatureChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Temperature (¬∞C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            parser: 'YYYY-MM-DDTHH:mm:ss',
                            tooltipFormat: 'HH:mm:ss',
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        },
                        suggestedMin: 30,
                        suggestedMax: 80
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Function to fetch and update temperature history
        async function fetchTemperatureHistory() {
            try {
                const response = await fetch('/api/temperature-history');
                const data = await response.json();
                
                if (data.history) {
                    const labels = data.history.map(item => item.timestamp);
                    const temperatures = data.history.map(item => item.temperature);
                    
                    temperatureChart.data.labels = labels;
                    temperatureChart.data.datasets[0].data = temperatures;
                    temperatureChart.update();
                }
            } catch (error) {
                console.error('Error fetching temperature history:', error);
            }
        }
        
        // Function to fetch and display system information
        async function fetchSystemInfo() {
            try {
                const response = await fetch('/api/system');
                const data = await response.json();
                
                // Update system info
                const systemInfo = document.getElementById('system-info');
                systemInfo.innerHTML = `
                    <div class="info-item"><strong>Hostname:</strong> ${data.hostname}</div>
                    <div class="info-item"><strong>Platform:</strong> ${data.platform} ${data.platform_release}</div>
                    <div class="info-item"><strong>Architecture:</strong> ${data.architecture}</div>
                    <div class="info-item"><strong>Boot Time:</strong> ${data.boot_time}</div>
                    <div class="info-item"><strong>CPU Cores:</strong> ${data.physical_cores} physical, ${data.total_cores} total</div>
                `;
                
                // Update memory details
                document.getElementById('memory-detail').textContent = 
                    `${data.memory_used} / ${data.memory_total}`;
                
                // Update network info
                const networkInfo = document.getElementById('network-info');
                networkInfo.innerHTML = data.network_info.map(net => 
                    `<div class="info-item"><strong>${net.interface}:</strong> ${net.ip}</div>`
                ).join('');
                
                // Update disk info
                const diskInfo = document.getElementById('disk-info');
                diskInfo.innerHTML = data.disk_info.map(disk => `
                    <div class="disk-item">
                        <div class="disk-header">
                            <strong>${disk.device}</strong> (${disk.file_system}) - ${disk.mountpoint}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${disk.percentage}"></div>
                        </div>
                        <div class="disk-details">
                            ${disk.used} used of ${disk.total_size} (${disk.free} free)
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error fetching system info:', error);
            }
        }
        
        // Function to fetch real-time stats
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                // Update CPU usage
                document.getElementById('cpu-usage').textContent = `${data.cpu_percent.toFixed(1)}%`;
                
                // Update CPU temperature
                if (data.cpu_temp !== null) {
                    document.getElementById('cpu-temp').textContent = `${data.cpu_temp.toFixed(1)}¬∞C`;
                } else {
                    document.getElementById('cpu-temp').textContent = 'N/A';
                }
                
                // Update memory usage
                document.getElementById('memory-usage').textContent = `${data.memory_percent.toFixed(1)}%`;
                
                // Update last update time
                document.getElementById('last-update').textContent = 
                    new Date(data.timestamp).toLocaleTimeString();
                
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        // Initial load
        fetchSystemInfo();
        fetchStats();
        fetchTemperatureHistory();
        
        // Update stats every 5 seconds (reduced frequency for Pi Zero 2 W)
        setInterval(fetchStats, 5000);
        
        // Update temperature history every 5 seconds to match sampling rate
        setInterval(fetchTemperatureHistory, 5000);
        
        // Update full system info every 60 seconds (reduced frequency for Pi Zero 2 W)
        setInterval(fetchSystemInfo, 60000);
    </script>
</body>
</html>