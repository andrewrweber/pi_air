<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi System Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>üçì Pi Air Monitor</h1>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('air-quality')">Air Quality</button>
                <button class="tab-button" onclick="showTab('hardware')">Pi Hardware</button>
            </div>
            
            <div id="hardware-tab" class="tab-content">
                <div class="stats-grid">
            <div class="stat-card">
                <h2>CPU</h2>
                <div class="stat-value" id="cpu-usage">Loading...</div>
                <div class="stat-label">Usage</div>
                <div class="stat-value" id="cpu-temp">Loading...</div>
                <div class="stat-label">Temperature</div>
            </div>
            
            <div class="stat-card">
                <h2>Memory</h2>
                <div class="stat-value" id="memory-usage">Loading...</div>
                <div class="stat-label">Usage</div>
                <div class="stat-detail" id="memory-detail"></div>
            </div>
            
            <div class="stat-card">
                <h2>System Info</h2>
                <div id="system-info" class="info-list"></div>
            </div>
            
            <div class="stat-card">
                <h2>Network</h2>
                <div id="network-info" class="info-list"></div>
            </div>
        </div>
        
        <div class="disk-section">
            <h2>Disk Usage</h2>
            <div id="disk-info"></div>
        </div>
        
                <div class="temperature-section">
                    <h2>CPU Temperature History</h2>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                    <div class="chart-controls">
                        <button id="temp-realtime-btn" class="chart-btn active" onclick="showTemperatureData('realtime')">Real-time (10min)</button>
                        <button id="temp-database-btn" class="chart-btn" onclick="showTemperatureData('database')">Historical (24h)</button>
                    </div>
                </div>
                
                <div class="system-metrics-section">
                    <h2>System Metrics History (24 hours)</h2>
                    <div style="position: relative; height:400px; width:100%;">
                        <canvas id="systemMetricsChart"></canvas>
                    </div>
                    <div class="metrics-controls">
                        <label><input type="checkbox" id="show-cpu-usage" checked> CPU Usage</label>
                        <label><input type="checkbox" id="show-memory-usage" checked> Memory Usage</label>
                        <label><input type="checkbox" id="show-disk-usage" checked> Disk Usage</label>
                        <label><input type="checkbox" id="show-cpu-temp" checked> CPU Temperature</label>
                    </div>
                </div>
            </div>
            
            <div id="air-quality-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card" id="air-quality-card">
                        <h2>Current Air Quality</h2>
                        <div class="stat-value" id="aqi-value">--</div>
                        <div class="stat-label" id="aqi-level">--</div>
                        <div class="air-quality-details">
                            <div class="air-metric">PM1.0: <span id="pm1-value">--</span> Œºg/m¬≥</div>
                            <div class="air-metric">PM2.5: <span id="pm25-value">--</span> Œºg/m¬≥</div>
                            <div class="air-metric">PM10: <span id="pm10-value">--</span> Œºg/m¬≥</div>
                        </div>
                    </div>
                </div>
                
                <div class="air-quality-section" id="air-quality-history-section">
                    <h2 id="particles-chart-title">Particle Concentrations (24 hours, 15-minute intervals)</h2>
                    <div style="position: relative; height:350px; width:100%;">
                        <canvas id="particlesChart"></canvas>
                    </div>
                    <div class="chart-controls">
                        <button id="particles-1h-btn" class="chart-btn" onclick="showParticlesData('1h')">1 Hour</button>
                        <button id="particles-6h-btn" class="chart-btn" onclick="showParticlesData('6h')">6 Hours</button>
                        <button id="particles-24h-btn" class="chart-btn active" onclick="showParticlesData('24h')">24 Hours</button>
                    </div>
                    
                    <h2 style="margin-top: 2rem;" id="aqi-chart-title">Air Quality Index (24 hours, 15-minute intervals)</h2>
                    <div style="position: relative; height:300px; width:100%;">
                        <canvas id="aqiChart"></canvas>
                    </div>
                    <div class="chart-controls">
                        <button id="aqi-1h-btn" class="chart-btn" onclick="showAQIData('1h')">1 Hour</button>
                        <button id="aqi-6h-btn" class="chart-btn" onclick="showAQIData('6h')">6 Hours</button>
                        <button id="aqi-24h-btn" class="chart-btn active" onclick="showAQIData('24h')">24 Hours</button>
                    </div>
                    <div class="db-stats" id="db-stats"></div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Last updated: <span id="last-update">Never</span></p>
        </div>
    </div>
    
    <script>
        // Tab switching function
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // If switching to air quality tab, update current readings immediately
            if (tabName === 'air-quality') {
                updateCurrentAirQuality();
            }
        }
        
        // Initialize temperature chart
        const tempCtx = document.getElementById('temperatureChart').getContext('2d');
        const temperatureChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Temperature (¬∞C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        },
                        suggestedMin: 30,
                        suggestedMax: 80
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Initialize system metrics chart
        const sysCtx = document.getElementById('systemMetricsChart').getContext('2d');
        const systemMetricsChart = new Chart(sysCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y-percentage',
                        spanGaps: true
                    },
                    {
                        label: 'Memory Usage (%)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y-percentage',
                        spanGaps: true
                    },
                    {
                        label: 'Disk Usage (%)',
                        data: [],
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y-percentage',
                        spanGaps: true
                    },
                    {
                        label: 'CPU Temperature (¬∞C)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y-temperature',
                        spanGaps: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    'y-percentage': {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Usage (%)'
                        },
                        min: 0,
                        max: 100
                    },
                    'y-temperature': {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        },
                        min: 30,
                        max: 80,
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        // Initialize particles chart
        const particlesCtx = document.getElementById('particlesChart').getContext('2d');
        const particlesChart = new Chart(particlesCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'PM2.5 (Œºg/m¬≥)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1,
                        spanGaps: true
                    },
                    {
                        label: 'PM10 (Œºg/m¬≥)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1,
                        spanGaps: true
                    },
                    {
                        label: 'PM1.0 (Œºg/m¬≥)',
                        data: [],
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.1)',
                        tension: 0.1,
                        spanGaps: true,
                        hidden: true  // Hidden by default
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Particulate Matter (Œºg/m¬≥)'
                        },
                        min: 0,
                        suggestedMax: 50,
                        ticks: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        // Initialize AQI chart
        const aqiCtx = document.getElementById('aqiChart').getContext('2d');
        const aqiChart = new Chart(aqiCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Air Quality Index',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        spanGaps: true,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Air Quality Index'
                        },
                        min: 0,
                        suggestedMax: 100,
                        ticks: {
                            beginAtZero: true,
                            stepSize: 50,
                            callback: function(value) {
                                // Add AQI level labels
                                if (value === 0) return '0';
                                if (value === 50) return '50 (Good)';
                                if (value === 100) return '100 (Moderate)';
                                if (value === 150) return '150 (Unhealthy for Sensitive)';
                                if (value === 200) return '200 (Unhealthy)';
                                if (value === 300) return '300 (Very Unhealthy)';
                                if (value === 500) return '500 (Hazardous)';
                                return value;
                            }
                        },
                        grid: {
                            color: function(context) {
                                const value = context.tick.value;
                                if (value === 50) return 'rgba(0, 228, 0, 0.2)';
                                if (value === 100) return 'rgba(255, 255, 0, 0.2)';
                                if (value === 150) return 'rgba(255, 126, 0, 0.2)';
                                if (value === 200) return 'rgba(255, 0, 0, 0.2)';
                                if (value === 300) return 'rgba(143, 63, 151, 0.2)';
                                return 'rgba(0, 0, 0, 0.1)';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false  // Single dataset, no need for legend
                    }
                }
            }
        });
        
        // Global state for temperature chart
        let currentTemperatureView = 'realtime';
        
        // Global state for air quality time ranges (separate for each chart)
        let currentParticlesTimeRange = '24h';
        let currentAQITimeRange = '24h';
        
        // Function to fetch and update temperature history
        async function fetchTemperatureHistory() {
            try {
                const response = await fetch('/api/temperature-history');
                const data = await response.json();
                
                // Update chart based on current view
                if (currentTemperatureView === 'realtime' && data.real_time_history && data.real_time_history.length > 0) {
                    // Format timestamps for real-time data
                    const labels = data.real_time_history.map(item => {
                        const date = new Date(item.timestamp);
                        return date.toLocaleString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            second: '2-digit',
                            timeZone: 'America/Los_Angeles',
                            timeZoneName: 'short'
                        });
                    });
                    const temperatures = data.real_time_history.map(item => item.temperature);
                    
                    temperatureChart.data.labels = labels;
                    temperatureChart.data.datasets[0].data = temperatures;
                    temperatureChart.update('none');
                } else if (currentTemperatureView === 'database' && data.database_history && data.database_history.length > 0) {
                    // Format timestamps for database data (longer timeframe)
                    const labels = data.database_history.map(item => {
                        const date = new Date(item.timestamp);
                        return date.toLocaleString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            timeZone: 'America/Los_Angeles',
                            timeZoneName: 'short'
                        });
                    });
                    const temperatures = data.database_history.map(item => item.cpu_temp).filter(temp => temp !== null);
                    
                    temperatureChart.data.labels = labels;
                    temperatureChart.data.datasets[0].data = temperatures;
                    temperatureChart.update('none');
                }
            } catch (error) {
                console.error('Error fetching temperature history:', error);
            }
        }
        
        // Function to switch temperature data view
        function showTemperatureData(view) {
            currentTemperatureView = view;
            
            // Update button states
            document.getElementById('temp-realtime-btn').classList.toggle('active', view === 'realtime');
            document.getElementById('temp-database-btn').classList.toggle('active', view === 'database');
            
            // Refresh data
            fetchTemperatureHistory();
        }
        
        // Function to fetch and update system metrics history
        async function fetchSystemHistory() {
            try {
                const response = await fetch('/api/system-history');
                const data = await response.json();
                
                if (data.hourly_averages && data.hourly_averages.length > 0) {
                    // Format timestamps for hourly data
                    const labels = data.hourly_averages.map(item => {
                        // SQLite CURRENT_TIMESTAMP stores in UTC, but strftime returns local format without timezone
                        // We need to treat these as UTC timestamps by appending 'Z'
                        const date = new Date(item.hour + 'Z');
                        return date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric',
                            minute: '2-digit',
                            timeZone: 'America/Los_Angeles',
                            timeZoneName: 'short'
                        });
                    });
                    
                    const cpuUsageData = data.hourly_averages.map(item => item.avg_cpu_usage);
                    const memoryUsageData = data.hourly_averages.map(item => item.avg_memory_usage);
                    const diskUsageData = data.hourly_averages.map(item => item.avg_disk_usage);
                    const cpuTempData = data.hourly_averages.map(item => item.avg_cpu_temp);
                    
                    // Update chart data
                    systemMetricsChart.data.labels = labels;
                    systemMetricsChart.data.datasets[0].data = cpuUsageData;
                    systemMetricsChart.data.datasets[1].data = memoryUsageData;
                    systemMetricsChart.data.datasets[2].data = diskUsageData;
                    systemMetricsChart.data.datasets[3].data = cpuTempData;
                    
                    // Update chart visibility based on checkboxes
                    updateSystemMetricsVisibility();
                    
                    systemMetricsChart.update('none');
                }
            } catch (error) {
                console.error('Error fetching system history:', error);
            }
        }
        
        // Function to update system metrics chart visibility
        function updateSystemMetricsVisibility() {
            systemMetricsChart.data.datasets[0].hidden = !document.getElementById('show-cpu-usage').checked;
            systemMetricsChart.data.datasets[1].hidden = !document.getElementById('show-memory-usage').checked;
            systemMetricsChart.data.datasets[2].hidden = !document.getElementById('show-disk-usage').checked;
            systemMetricsChart.data.datasets[3].hidden = !document.getElementById('show-cpu-temp').checked;
            systemMetricsChart.update('none');
        }
        
        // Add event listeners for system metrics checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('show-cpu-usage').addEventListener('change', updateSystemMetricsVisibility);
            document.getElementById('show-memory-usage').addEventListener('change', updateSystemMetricsVisibility);
            document.getElementById('show-disk-usage').addEventListener('change', updateSystemMetricsVisibility);
            document.getElementById('show-cpu-temp').addEventListener('change', updateSystemMetricsVisibility);
        });
        
        // Function to fetch and display system information
        async function fetchSystemInfo() {
            try {
                const response = await fetch('/api/system');
                const data = await response.json();
                
                // Update system info
                const systemInfo = document.getElementById('system-info');
                systemInfo.innerHTML = `
                    <div class="info-item"><strong>Hostname:</strong> ${data.hostname}</div>
                    <div class="info-item"><strong>Platform:</strong> ${data.platform} ${data.platform_release}</div>
                    <div class="info-item"><strong>Architecture:</strong> ${data.architecture}</div>
                    <div class="info-item"><strong>Boot Time:</strong> ${data.boot_time}</div>
                    <div class="info-item"><strong>CPU Cores:</strong> ${data.physical_cores} physical, ${data.total_cores} total</div>
                `;
                
                // Update memory details
                document.getElementById('memory-detail').textContent = 
                    `${data.memory_used} / ${data.memory_total}`;
                
                // Update network info
                const networkInfo = document.getElementById('network-info');
                networkInfo.innerHTML = data.network_info.map(net => 
                    `<div class="info-item"><strong>${net.interface}:</strong> ${net.ip}</div>`
                ).join('');
                
                // Update disk info
                const diskInfo = document.getElementById('disk-info');
                diskInfo.innerHTML = data.disk_info.map(disk => `
                    <div class="disk-item">
                        <div class="disk-header">
                            <strong>${disk.device}</strong> (${disk.file_system}) - ${disk.mountpoint}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${disk.percentage}"></div>
                        </div>
                        <div class="disk-details">
                            ${disk.used} used of ${disk.total_size} (${disk.free} free)
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error fetching system info:', error);
            }
        }
        
        // Function to fetch real-time stats
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                // Update CPU usage
                document.getElementById('cpu-usage').textContent = `${data.cpu_percent.toFixed(1)}%`;
                
                // Update CPU temperature
                if (data.cpu_temp !== null) {
                    document.getElementById('cpu-temp').textContent = `${data.cpu_temp.toFixed(1)}¬∞C`;
                } else {
                    document.getElementById('cpu-temp').textContent = 'N/A';
                }
                
                // Update memory usage
                document.getElementById('memory-usage').textContent = `${data.memory_percent.toFixed(1)}%`;
                
                // Skip air quality updates in fetchStats - handled separately for air quality tab
                // Air quality will be updated by updateCurrentAirQuality() when that tab is active
                
                // Update last update time
                document.getElementById('last-update').textContent = 
                    new Date(data.timestamp).toLocaleTimeString();
                
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        // Function to update current air quality display with latest reading
        async function updateCurrentAirQuality() {
            try {
                const response = await fetch('/api/air-quality-latest');
                const data = await response.json();
                
                console.log('Latest air quality reading from API:', data);
                
                // Update current reading display with actual latest sensor reading
                if (data.latest_reading) {
                    const reading = data.latest_reading;
                    console.log('Using latest sensor reading:', reading);
                    
                    // Update current values - these are actual sensor readings, not averages
                    document.getElementById('aqi-value').textContent = reading.aqi || '--';
                    document.getElementById('pm1-value').textContent = (reading.pm1_0 !== null && reading.pm1_0 !== undefined) ? reading.pm1_0.toFixed(1) : '--';
                    document.getElementById('pm25-value').textContent = (reading.pm2_5 !== null && reading.pm2_5 !== undefined) ? reading.pm2_5.toFixed(1) : '--';
                    document.getElementById('pm10-value').textContent = (reading.pm10 !== null && reading.pm10 !== undefined) ? reading.pm10.toFixed(1) : '--';
                    
                    // Update AQI level and color
                    const aqi = reading.aqi;
                    const aqiElement = document.getElementById('aqi-value');
                    const aqiLevelElement = document.getElementById('aqi-level');
                    
                    if (aqi !== null && aqi !== undefined) {
                        let level, color;
                        if (aqi <= 50) {
                            level = 'Good';
                            color = '#00e400';
                        } else if (aqi <= 100) {
                            level = 'Moderate';
                            color = '#ffff00';
                        } else if (aqi <= 150) {
                            level = 'Unhealthy for Sensitive';
                            color = '#ff7e00';
                        } else if (aqi <= 200) {
                            level = 'Unhealthy';
                            color = '#ff0000';
                        } else if (aqi <= 300) {
                            level = 'Very Unhealthy';
                            color = '#8f3f97';
                        } else {
                            level = 'Hazardous';
                            color = '#7e0023';
                        }
                        
                        aqiElement.style.color = color;
                        aqiLevelElement.textContent = level;
                    } else {
                        aqiLevelElement.textContent = '--';
                    }
                } else {
                    console.log('No latest reading available, trying stats API fallback');
                    // Fallback to stats API if no latest reading available
                    try {
                        const statsResponse = await fetch('/api/stats');
                        const statsData = await statsResponse.json();
                        
                        if (statsData.air_quality) {
                            document.getElementById('aqi-value').textContent = statsData.air_quality.aqi;
                            document.getElementById('aqi-level').textContent = statsData.air_quality.aqi_level;
                            document.getElementById('pm1-value').textContent = statsData.air_quality.pm1_0;
                            document.getElementById('pm25-value').textContent = statsData.air_quality.pm2_5;
                            document.getElementById('pm10-value').textContent = statsData.air_quality.pm10;
                            
                            // Set AQI color
                            const aqiElement = document.getElementById('aqi-value');
                            const aqi = statsData.air_quality.aqi;
                            if (aqi <= 50) {
                                aqiElement.style.color = '#00e400';
                            } else if (aqi <= 100) {
                                aqiElement.style.color = '#ffff00';
                            } else if (aqi <= 150) {
                                aqiElement.style.color = '#ff7e00';
                            } else if (aqi <= 200) {
                                aqiElement.style.color = '#ff0000';
                            } else if (aqi <= 300) {
                                aqiElement.style.color = '#8f3f97';
                            } else {
                                aqiElement.style.color = '#7e0023';
                            }
                        }
                    } catch (statsError) {
                        console.error('Error fetching stats API fallback:', statsError);
                    }
                }
            } catch (error) {
                console.error('Error updating current air quality:', error);
            }
        }
        
        // Function to fetch and update air quality history
        async function fetchAirQualityHistory() {
            try {
                // Fetch data for the longer time range to cover both charts
                const maxRange = getMaxTimeRange();
                const response = await fetch(`/api/air-quality-history?range=${maxRange}`);
                const data = await response.json();
                
                console.log('Air quality data received:', data);
                console.log('First interval raw:', data.interval_averages[0]?.interval_time);
                if (data.interval_averages[0]) {
                    const rawDate = new Date(data.interval_averages[0].interval_time);
                    const utcDate = new Date(data.interval_averages[0].interval_time + 'Z');
                    console.log('Raw date parse:', rawDate.toISOString());
                    console.log('UTC date parse:', utcDate.toISOString());
                    console.log('PST converted:', utcDate.toLocaleString('en-US', { 
                        timeZone: 'America/Los_Angeles',
                        timeZoneName: 'short'
                    }));
                }
                
                if (data.interval_averages && data.interval_averages.length > 0) {
                    // Update both charts with their respective time ranges
                    updateParticlesChart(data.interval_averages);
                    updateAQIChart(data.interval_averages);
                    
                    // Update database stats
                    if (data.stats) {
                        const statsHtml = `
                            <p class="db-stat-item">
                                Total air quality readings: ${data.stats.total_air_quality_readings || data.stats.total_readings || 0} | 
                                Database size: ${data.stats.db_size_kb} KB
                            </p>
                        `;
                        document.getElementById('db-stats').innerHTML = statsHtml;
                    }
                } else {
                    console.log('No interval averages data available');
                    // Show empty charts with message
                    particlesChart.data.labels = ['No data available'];
                    particlesChart.data.datasets[0].data = [];
                    particlesChart.data.datasets[1].data = [];
                    particlesChart.data.datasets[2].data = [];
                    particlesChart.update();
                    
                    aqiChart.data.labels = ['No data available'];
                    aqiChart.data.datasets[0].data = [];
                    aqiChart.update();
                }
                
            } catch (error) {
                console.error('Error fetching air quality history:', error);
            }
        }
        
        // Helper function to get max time range needed for both charts
        function getMaxTimeRange() {
            // Return the larger time range to ensure we fetch enough data
            const ranges = ['1h', '6h', '24h'];
            const particlesIdx = ranges.indexOf(currentParticlesTimeRange);
            const aqiIdx = ranges.indexOf(currentAQITimeRange);
            return ranges[Math.max(particlesIdx, aqiIdx)];
        }
        
        // Helper function to filter data by time range
        function filterDataByTimeRange(data, timeRange) {
            const now = new Date();
            let hoursAgo;
            switch(timeRange) {
                case '1h':
                    hoursAgo = 1;
                    break;
                case '6h':
                    hoursAgo = 6;
                    break;
                default:
                    hoursAgo = 24;
            }
            const cutoffTime = new Date(now.getTime() - (hoursAgo * 60 * 60 * 1000));
            
            return data.filter(item => {
                const itemTime = new Date(item.interval_time + 'Z');
                return itemTime >= cutoffTime;
            });
        }
        
        // Function to update particles chart
        function updateParticlesChart(allData) {
            const filteredData = filterDataByTimeRange(allData, currentParticlesTimeRange);
            
            if (filteredData.length > 0) {
                const labels = filteredData.map(item => {
                    const utcDate = new Date(item.interval_time + 'Z');
                    return utcDate.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: 'numeric',
                        minute: '2-digit',
                        timeZone: 'America/Los_Angeles',
                        timeZoneName: 'short'
                    });
                });
                
                const pm1Data = filteredData.map(item => item.avg_pm1_0);
                const pm25Data = filteredData.map(item => item.avg_pm2_5);
                const pm10Data = filteredData.map(item => item.avg_pm10);
                
                // Calculate dynamic max values for better scaling
                const maxPM = Math.max(
                    ...pm1Data.filter(v => v !== null),
                    ...pm25Data.filter(v => v !== null),
                    ...pm10Data.filter(v => v !== null),
                    10  // minimum
                );
                
                particlesChart.options.scales.y.suggestedMax = Math.ceil(maxPM * 1.2);
                particlesChart.data.labels = labels;
                particlesChart.data.datasets[0].data = pm25Data;
                particlesChart.data.datasets[1].data = pm10Data;
                particlesChart.data.datasets[2].data = pm1Data;
                particlesChart.update();
            } else {
                const hoursAgo = currentParticlesTimeRange === '1h' ? 1 : (currentParticlesTimeRange === '6h' ? 6 : 24);
                const noDataMsg = `No data in the last ${hoursAgo} hour${hoursAgo > 1 ? 's' : ''}`;
                
                particlesChart.data.labels = [noDataMsg];
                particlesChart.data.datasets[0].data = [];
                particlesChart.data.datasets[1].data = [];
                particlesChart.data.datasets[2].data = [];
                particlesChart.update();
            }
        }
        
        // Function to update AQI chart
        function updateAQIChart(allData) {
            const filteredData = filterDataByTimeRange(allData, currentAQITimeRange);
            
            if (filteredData.length > 0) {
                const labels = filteredData.map(item => {
                    const utcDate = new Date(item.interval_time + 'Z');
                    return utcDate.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: 'numeric',
                        minute: '2-digit',
                        timeZone: 'America/Los_Angeles',
                        timeZoneName: 'short'
                    });
                });
                
                const aqiData = filteredData.map(item => item.avg_aqi);
                const maxAQI = Math.max(...aqiData.filter(v => v !== null), 50);
                
                // Update AQI chart with dynamic scaling
                aqiChart.options.scales.y.suggestedMax = Math.ceil(maxAQI * 1.2);
                // Ensure we show AQI scale up to at least 200 to show color bands
                if (aqiChart.options.scales.y.suggestedMax < 200) {
                    aqiChart.options.scales.y.suggestedMax = 200;
                }
                aqiChart.data.labels = labels;
                aqiChart.data.datasets[0].data = aqiData;
                
                // Color the AQI line based on the current value
                const currentAQI = aqiData[aqiData.length - 1];
                if (currentAQI !== null && currentAQI !== undefined) {
                    let lineColor;
                    if (currentAQI <= 50) lineColor = 'rgb(0, 228, 0)';
                    else if (currentAQI <= 100) lineColor = 'rgb(255, 255, 0)';
                    else if (currentAQI <= 150) lineColor = 'rgb(255, 126, 0)';
                    else if (currentAQI <= 200) lineColor = 'rgb(255, 0, 0)';
                    else if (currentAQI <= 300) lineColor = 'rgb(143, 63, 151)';
                    else lineColor = 'rgb(126, 0, 35)';
                    
                    aqiChart.data.datasets[0].borderColor = lineColor;
                    aqiChart.data.datasets[0].backgroundColor = lineColor.replace('rgb', 'rgba').replace(')', ', 0.1)');
                }
                
                aqiChart.update();
            } else {
                const hoursAgo = currentAQITimeRange === '1h' ? 1 : (currentAQITimeRange === '6h' ? 6 : 24);
                const noDataMsg = `No data in the last ${hoursAgo} hour${hoursAgo > 1 ? 's' : ''}`;
                
                aqiChart.data.labels = [noDataMsg];
                aqiChart.data.datasets[0].data = [];
                aqiChart.update();
            }
        }
        
        // Function to switch particles chart time range
        function showParticlesData(timeRange) {
            currentParticlesTimeRange = timeRange;
            
            // Update button states
            document.getElementById('particles-1h-btn').classList.remove('active');
            document.getElementById('particles-6h-btn').classList.remove('active');
            document.getElementById('particles-24h-btn').classList.remove('active');
            document.getElementById(`particles-${timeRange}-btn`).classList.add('active');
            
            // Update chart title
            let intervalText, hoursText;
            switch(timeRange) {
                case '1h':
                    intervalText = '2-minute intervals';
                    hoursText = '1 hour';
                    break;
                case '6h':
                    intervalText = '5-minute intervals';
                    hoursText = '6 hours';
                    break;
                case '24h':
                default:
                    intervalText = '15-minute intervals';
                    hoursText = '24 hours';
                    break;
            }
            
            document.getElementById('particles-chart-title').textContent = `Particle Concentrations (${hoursText}, ${intervalText})`;
            
            // Fetch new data if needed
            fetchAirQualityHistory();
        }
        
        // Function to switch AQI chart time range
        function showAQIData(timeRange) {
            currentAQITimeRange = timeRange;
            
            // Update button states
            document.getElementById('aqi-1h-btn').classList.remove('active');
            document.getElementById('aqi-6h-btn').classList.remove('active');
            document.getElementById('aqi-24h-btn').classList.remove('active');
            document.getElementById(`aqi-${timeRange}-btn`).classList.add('active');
            
            // Update chart title
            let intervalText, hoursText;
            switch(timeRange) {
                case '1h':
                    intervalText = '2-minute intervals';
                    hoursText = '1 hour';
                    break;
                case '6h':
                    intervalText = '5-minute intervals';
                    hoursText = '6 hours';
                    break;
                case '24h':
                default:
                    intervalText = '15-minute intervals';
                    hoursText = '24 hours';
                    break;
            }
            
            document.getElementById('aqi-chart-title').textContent = `Air Quality Index (${hoursText}, ${intervalText})`;
            
            // Fetch new data if needed
            fetchAirQualityHistory();
        }
        
        // Initial load
        fetchSystemInfo();
        fetchStats();
        fetchTemperatureHistory();
        fetchSystemHistory();
        fetchAirQualityHistory();
        updateCurrentAirQuality(); // Load air quality immediately since it's the default tab
        
        // Update stats every 5 seconds (reduced frequency for Pi Zero 2 W)
        setInterval(fetchStats, 5000);
        
        // Update temperature history every 5 seconds to match sampling rate
        setInterval(fetchTemperatureHistory, 5000);
        
        // Update system metrics history every 60 seconds
        setInterval(fetchSystemHistory, 60000);
        
        // Update air quality history every 30 seconds
        setInterval(fetchAirQualityHistory, 30000);
        
        // Update current air quality readings every 10 seconds when air quality tab is active
        setInterval(() => {
            const airQualityTab = document.getElementById('air-quality-tab');
            if (airQualityTab && airQualityTab.classList.contains('active')) {
                updateCurrentAirQuality();
            }
        }, 10000);
        
        // Update full system info every 60 seconds (reduced frequency for Pi Zero 2 W)
        setInterval(fetchSystemInfo, 60000);
    </script>
</body>
</html>