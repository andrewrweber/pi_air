<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi System Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>üçì Raspberry Pi System Monitor</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h2>CPU</h2>
                <div class="stat-value" id="cpu-usage">Loading...</div>
                <div class="stat-label">Usage</div>
                <div class="stat-value" id="cpu-temp">Loading...</div>
                <div class="stat-label">Temperature</div>
            </div>
            
            <div class="stat-card">
                <h2>Memory</h2>
                <div class="stat-value" id="memory-usage">Loading...</div>
                <div class="stat-label">Usage</div>
                <div class="stat-detail" id="memory-detail"></div>
            </div>
            
            <div class="stat-card">
                <h2>System Info</h2>
                <div id="system-info" class="info-list"></div>
            </div>
            
            <div class="stat-card">
                <h2>Network</h2>
                <div id="network-info" class="info-list"></div>
            </div>
            
            <div class="stat-card" id="air-quality-card" style="display: none;">
                <h2>Air Quality</h2>
                <div class="stat-value" id="aqi-value">--</div>
                <div class="stat-label" id="aqi-level">--</div>
                <div class="air-quality-details">
                    <div class="air-metric">PM1.0: <span id="pm1-value">--</span> Œºg/m¬≥</div>
                    <div class="air-metric">PM2.5: <span id="pm25-value">--</span> Œºg/m¬≥</div>
                    <div class="air-metric">PM10: <span id="pm10-value">--</span> Œºg/m¬≥</div>
                </div>
            </div>
        </div>
        
        <div class="disk-section">
            <h2>Disk Usage</h2>
            <div id="disk-info"></div>
        </div>
        
        <div class="temperature-section">
            <h2>CPU Temperature History (10 minutes)</h2>
            <div style="position: relative; height:300px; width:100%;">
                <canvas id="temperatureChart"></canvas>
            </div>
        </div>
        
        <div class="air-quality-section" id="air-quality-history-section" style="display: none;">
            <h2>Air Quality History (24 hours)</h2>
            <div style="position: relative; height:400px; width:100%;">
                <canvas id="airQualityChart"></canvas>
            </div>
            <div class="db-stats" id="db-stats"></div>
        </div>
        
        <div class="footer">
            <p>Last updated: <span id="last-update">Never</span></p>
        </div>
    </div>
    
    <script>
        // Initialize temperature chart
        const tempCtx = document.getElementById('temperatureChart').getContext('2d');
        const temperatureChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Temperature (¬∞C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        },
                        suggestedMin: 30,
                        suggestedMax: 80
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Initialize air quality chart
        const aqCtx = document.getElementById('airQualityChart').getContext('2d');
        const airQualityChart = new Chart(aqCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'PM2.5 (Œºg/m¬≥)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y-pm'
                    },
                    {
                        label: 'PM10 (Œºg/m¬≥)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y-pm'
                    },
                    {
                        label: 'AQI',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y-aqi'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    'y-pm': {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Particulate Matter (Œºg/m¬≥)'
                        },
                        suggestedMin: 0
                    },
                    'y-aqi': {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Air Quality Index'
                        },
                        suggestedMin: 0,
                        suggestedMax: 200,
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
        
        // Function to fetch and update temperature history
        async function fetchTemperatureHistory() {
            try {
                const response = await fetch('/api/temperature-history');
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    // Format timestamps as HH:MM:SS
                    const labels = data.history.map(item => {
                        const date = new Date(item.timestamp);
                        return date.toLocaleTimeString();
                    });
                    const temperatures = data.history.map(item => item.temperature);
                    
                    temperatureChart.data.labels = labels;
                    temperatureChart.data.datasets[0].data = temperatures;
                    temperatureChart.update('none'); // Disable animation for performance
                }
            } catch (error) {
                console.error('Error fetching temperature history:', error);
            }
        }
        
        // Function to fetch and display system information
        async function fetchSystemInfo() {
            try {
                const response = await fetch('/api/system');
                const data = await response.json();
                
                // Update system info
                const systemInfo = document.getElementById('system-info');
                systemInfo.innerHTML = `
                    <div class="info-item"><strong>Hostname:</strong> ${data.hostname}</div>
                    <div class="info-item"><strong>Platform:</strong> ${data.platform} ${data.platform_release}</div>
                    <div class="info-item"><strong>Architecture:</strong> ${data.architecture}</div>
                    <div class="info-item"><strong>Boot Time:</strong> ${data.boot_time}</div>
                    <div class="info-item"><strong>CPU Cores:</strong> ${data.physical_cores} physical, ${data.total_cores} total</div>
                `;
                
                // Update memory details
                document.getElementById('memory-detail').textContent = 
                    `${data.memory_used} / ${data.memory_total}`;
                
                // Update network info
                const networkInfo = document.getElementById('network-info');
                networkInfo.innerHTML = data.network_info.map(net => 
                    `<div class="info-item"><strong>${net.interface}:</strong> ${net.ip}</div>`
                ).join('');
                
                // Update disk info
                const diskInfo = document.getElementById('disk-info');
                diskInfo.innerHTML = data.disk_info.map(disk => `
                    <div class="disk-item">
                        <div class="disk-header">
                            <strong>${disk.device}</strong> (${disk.file_system}) - ${disk.mountpoint}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${disk.percentage}"></div>
                        </div>
                        <div class="disk-details">
                            ${disk.used} used of ${disk.total_size} (${disk.free} free)
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error fetching system info:', error);
            }
        }
        
        // Function to fetch real-time stats
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                // Update CPU usage
                document.getElementById('cpu-usage').textContent = `${data.cpu_percent.toFixed(1)}%`;
                
                // Update CPU temperature
                if (data.cpu_temp !== null) {
                    document.getElementById('cpu-temp').textContent = `${data.cpu_temp.toFixed(1)}¬∞C`;
                } else {
                    document.getElementById('cpu-temp').textContent = 'N/A';
                }
                
                // Update memory usage
                document.getElementById('memory-usage').textContent = `${data.memory_percent.toFixed(1)}%`;
                
                // Update air quality if available
                if (data.air_quality) {
                    document.getElementById('air-quality-card').style.display = 'block';
                    document.getElementById('aqi-value').textContent = data.air_quality.aqi;
                    document.getElementById('aqi-level').textContent = data.air_quality.aqi_level;
                    document.getElementById('pm1-value').textContent = data.air_quality.pm1_0;
                    document.getElementById('pm25-value').textContent = data.air_quality.pm2_5;
                    document.getElementById('pm10-value').textContent = data.air_quality.pm10;
                    
                    // Set AQI color based on level
                    const aqiElement = document.getElementById('aqi-value');
                    const aqi = data.air_quality.aqi;
                    if (aqi <= 50) {
                        aqiElement.style.color = '#00e400';  // Good - Green
                    } else if (aqi <= 100) {
                        aqiElement.style.color = '#ffff00';  // Moderate - Yellow
                    } else if (aqi <= 150) {
                        aqiElement.style.color = '#ff7e00';  // Unhealthy for Sensitive - Orange
                    } else if (aqi <= 200) {
                        aqiElement.style.color = '#ff0000';  // Unhealthy - Red
                    } else if (aqi <= 300) {
                        aqiElement.style.color = '#8f3f97';  // Very Unhealthy - Purple
                    } else {
                        aqiElement.style.color = '#7e0023';  // Hazardous - Maroon
                    }
                }
                
                // Update last update time
                document.getElementById('last-update').textContent = 
                    new Date(data.timestamp).toLocaleTimeString();
                
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        // Function to fetch and update air quality history
        async function fetchAirQualityHistory() {
            try {
                const response = await fetch('/api/air-quality-history');
                const data = await response.json();
                
                if (data.hourly_averages && data.hourly_averages.length > 0) {
                    // Show the section
                    document.getElementById('air-quality-history-section').style.display = 'block';
                    
                    // Prepare data for chart
                    const labels = data.hourly_averages.map(item => {
                        const date = new Date(item.hour);
                        return date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric' 
                        });
                    });
                    
                    const pm25Data = data.hourly_averages.map(item => item.avg_pm2_5);
                    const pm10Data = data.hourly_averages.map(item => item.avg_pm10);
                    const aqiData = data.hourly_averages.map(item => item.avg_aqi);
                    
                    // Update chart
                    airQualityChart.data.labels = labels;
                    airQualityChart.data.datasets[0].data = pm25Data;
                    airQualityChart.data.datasets[1].data = pm10Data;
                    airQualityChart.data.datasets[2].data = aqiData;
                    airQualityChart.update();
                    
                    // Update database stats
                    if (data.stats) {
                        const statsHtml = `
                            <p class="db-stat-item">
                                Total readings: ${data.stats.total_readings} | 
                                Database size: ${data.stats.db_size_kb} KB
                            </p>
                        `;
                        document.getElementById('db-stats').innerHTML = statsHtml;
                    }
                }
                
            } catch (error) {
                console.error('Error fetching air quality history:', error);
            }
        }
        
        // Initial load
        fetchSystemInfo();
        fetchStats();
        fetchTemperatureHistory();
        fetchAirQualityHistory();
        
        // Update stats every 5 seconds (reduced frequency for Pi Zero 2 W)
        setInterval(fetchStats, 5000);
        
        // Update temperature history every 5 seconds to match sampling rate
        setInterval(fetchTemperatureHistory, 5000);
        
        // Update air quality history every 30 seconds
        setInterval(fetchAirQualityHistory, 30000);
        
        // Update full system info every 60 seconds (reduced frequency for Pi Zero 2 W)
        setInterval(fetchSystemInfo, 60000);
    </script>
</body>
</html>